<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:IapDesktop.Application.Avalonia.ViewModels"
        xmlns:views="using:IapDesktop.Application.Avalonia.Views"
        mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
        x:Class="IapDesktop.Application.Avalonia.MainWindow"
        x:DataType="vm:MainViewModel"
        Title="IAP Desktop (macOS Port)"
        Icon="avares://IapDesktop.Application.Avalonia/Assets/logo.ico"
        TransparencyLevelHint="None"
        Background="#1E1E1E">

    <Design.DataContext>
        <vm:MainViewModel/>
    </Design.DataContext>
    
    <Window.DataTemplates>
        <DataTemplate DataType="vm:ConnectionViewModel">
             <views:ConnectionView/>
        </DataTemplate>
         <DataTemplate DataType="vm:RdpSessionViewModel">
             <views:RdpSessionView/>
        </DataTemplate>
         <DataTemplate DataType="vm:SftpBrowserViewModel">
             <views:SftpBrowserView/>
        </DataTemplate>
    </Window.DataTemplates>

    <DockPanel>
        <!-- Custom Title Bar (simulated/native) -->
        <!-- We use native for now as requested -->
        
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top" Background="#2D2D30" Foreground="#F1F1F1">
            <MenuItem Header="_File" Foreground="#F1F1F1">
                <MenuItem Header="_Exit" InputGesture="Cmd+Q" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="_View" Foreground="#F1F1F1">
                <MenuItem Header="_Project Explorer"/>
                <MenuItem Header="_Output Window"/>
            </MenuItem>
            <MenuItem Header="_Tools" Foreground="#F1F1F1">
                 <MenuItem Header="Options..."/>
            </MenuItem>
            <MenuItem Header="_Help" Foreground="#F1F1F1">
                <MenuItem Header="_About"/>
            </MenuItem>
        </Menu>
        
        <!-- Toolbar -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Background="#2D2D30" Height="40">
             <Button Margin="5" Command="{Binding ProjectExplorer.ConnectCommand}" ToolTip.Tip="Connect via SSH (External)" Background="Transparent" BorderThickness="0">
                 <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ’»" FontSize="16" Foreground="#007ACC"/>
                    <TextBlock Text=" Connect" Foreground="#F1F1F1" VerticalAlignment="Center" Margin="5,0,0,0"/>
                 </StackPanel>
             </Button>
             <Border Width="1" Background="#3E3E42" Margin="5"/>
             <Button Margin="5" Command="{Binding ProjectExplorer.ConnectRdpCommand}" ToolTip.Tip="Connect via RDP" Background="Transparent" BorderThickness="0">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ–¥ï¸" FontSize="16" Foreground="#007ACC"/>
                    <TextBlock Text=" RDP" Foreground="#F1F1F1" VerticalAlignment="Center" Margin="5,0,0,0"/>
                 </StackPanel>
             </Button>
             <Button Margin="5" Command="{Binding ProjectExplorer.ConnectSftpCommand}" ToolTip.Tip="SFTP Browser" Background="Transparent" BorderThickness="0">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ“‚" FontSize="16" Foreground="#007ACC"/>
                    <TextBlock Text=" SFTP" Foreground="#F1F1F1" VerticalAlignment="Center" Margin="5,0,0,0"/>
                 </StackPanel>
             </Button>
        </StackPanel>

        <!-- Main Status Bar -->
        <Border DockPanel.Dock="Bottom" Background="#007ACC" Height="25">
             <TextBlock Text="Ready" Foreground="White" Margin="5,0" VerticalAlignment="Center" FontSize="12"/>
        </Border>

        <!-- Main Content Split -->
        <Grid ColumnDefinitions="300, 5, *">
             
            <!-- Project Explorer (Left) -->
            <DockPanel Grid.Column="0" Background="#252526">
                <Border DockPanel.Dock="Top" Padding="10" Background="#2D2D30">
                     <TextBlock Text="PROJECT EXPLORER" FontWeight="Bold" Foreground="#F1F1F1" FontSize="12"/>
                </Border>
                
                <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="5">
                    <TextBox x:Name="ProjectIdBox" Watermark="Project ID" Width="180" Margin="0,0,5,0" Background="#333333" Foreground="White" BorderThickness="1" BorderBrush="#3F3F46"/>
                    <Button Command="{Binding ProjectExplorer.LoadNodesCommand}" CommandParameter="{Binding #ProjectIdBox.Text}" Content="âŸ³" ToolTip.Tip="Load Project" Background="#333333" Foreground="White"/>
                </StackPanel>
                
                <TreeView ItemsSource="{Binding ProjectExplorer.RootNodes}" SelectedItem="{Binding ProjectExplorer.SelectedNode}" Background="#252526" Foreground="#F1F1F1" BorderThickness="0">
                    <TreeView.Styles>
                        <Style Selector="TreeViewItem">
                            <Setter Property="Foreground" Value="#F1F1F1"/>
                        </Style>
                    </TreeView.Styles>
                    <TreeView.DataTemplates>
                        <TreeDataTemplate DataType="vm:ProjectNode" ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="â˜ï¸" Margin="0,0,5,0"/>
                                <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                                <StackPanel.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Remove Project" 
                                                  Command="{Binding $parent[Window].((vm:MainViewModel)DataContext).ProjectExplorer.RemoveProjectCommand}"
                                                  CommandParameter="{Binding}"/>
                                    </ContextMenu>
                                </StackPanel.ContextMenu>
                            </StackPanel>
                        </TreeDataTemplate>
                        <TreeDataTemplate DataType="vm:ZoneNode" ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“" Margin="0,0,5,0"/>
                                <TextBlock Text="{Binding Name}"/>
                            </StackPanel>
                        </TreeDataTemplate>
                        <DataTemplate DataType="vm:InstanceNode">
                             <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Icon}" Margin="0,0,5,0"/>
                                <TextBlock Text="{Binding Name}"/>
                                <StackPanel.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Connect via SSH" 
                                                  Command="{Binding $parent[Window].((vm:MainViewModel)DataContext).ProjectExplorer.ConnectCommand}"/>
                                        <MenuItem Header="Connect via RDP" 
                                                  Command="{Binding $parent[Window].((vm:MainViewModel)DataContext).ProjectExplorer.ConnectRdpCommand}"/>
                                        <MenuItem Header="Browse Files (SFTP)" 
                                                  Command="{Binding $parent[Window].((vm:MainViewModel)DataContext).ProjectExplorer.ConnectSftpCommand}"/>
                                    </ContextMenu>
                                </StackPanel.ContextMenu>
                            </StackPanel>
                        </DataTemplate>
                    </TreeView.DataTemplates>
                </TreeView>
            </DockPanel>
            
            <!-- Splitter -->
            <GridSplitter Grid.Column="1" Background="#333333" ResizeDirection="Columns"/>

            <!-- Active Sessions (Right) -->
            <Border Grid.Column="2" Background="#1E1E1E">
                <TabControl ItemsSource="{Binding Connections}" SelectedItem="{Binding SelectedConnection}" Background="#1E1E1E">
                    <TabControl.Styles>
                        <Style Selector="TabItem">
                            <Setter Property="FontSize" Value="12"/>
                            <Setter Property="Foreground" Value="#CCCCCC"/>
                            <Setter Property="Background" Value="#2D2D30"/>
                            <Setter Property="Margin" Value="0,0,2,0"/>
                        </Style>
                        <Style Selector="TabItem:selected">
                            <Setter Property="Background" Value="#1E1E1E"/>
                            <Setter Property="Foreground" Value="#007ACC"/>
                        </Style>
                    </TabControl.Styles>
                    <TabControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ’»" Margin="0,0,5,0" IsVisible="{Binding $parent[TabItem].Content, Converter={x:Static ObjectConverters.IsNull}}"/> 
                                <TextBlock Text="{Binding Title}"/>
                            </StackPanel>
                        </DataTemplate>
                    </TabControl.ItemTemplate>
                </TabControl>
            </Border>
        </Grid>
    </DockPanel>
</Window>
