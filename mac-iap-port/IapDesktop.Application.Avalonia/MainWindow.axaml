<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:IapDesktop.Application.Avalonia.ViewModels"
        xmlns:views="using:IapDesktop.Application.Avalonia.Views"
        mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
        x:Class="IapDesktop.Application.Avalonia.MainWindow"
        x:DataType="vm:MainViewModel"
        Title="IAP Desktop (macOS Port)"
        TransparencyLevelHint="None"
        Background="#1E1E1E"
        ExtendClientAreaToDecorationsHint="True">

    <Design.DataContext>
        <vm:MainViewModel/>
    </Design.DataContext>
    
    <Window.DataTemplates>
        <DataTemplate DataType="vm:ConnectionViewModel">
             <views:ConnectionView/>
        </DataTemplate>
         <DataTemplate DataType="vm:RdpSessionViewModel">
             <views:RdpSessionView/>
        </DataTemplate>
         <DataTemplate DataType="vm:SftpBrowserViewModel">
             <views:SftpBrowserView/>
        </DataTemplate>
    </Window.DataTemplates>

    <DockPanel>
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_Exit" InputGesture="Cmd+Q" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="_Project Explorer"/>
                <MenuItem Header="_Output Window"/>
            </MenuItem>
            <MenuItem Header="_Tools">
                 <MenuItem Header="Options..."/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About"/>
            </MenuItem>
        </Menu>
        
        <!-- Toolbar -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Background="#252526" Height="40">
             <Button Margin="5" Command="{Binding ProjectExplorer.ConnectCommand}" ToolTip.Tip="Connect via SSH">
                 <TextBlock Text="SSH ðŸ’»"/>
             </Button>
             <Button Margin="5" Command="{Binding ProjectExplorer.ConnectRdpCommand}" ToolTip.Tip="Connect via RDP">
                 <TextBlock Text="RDP ðŸ–¥ï¸"/>
             </Button>
             <Button Margin="5" Command="{Binding ProjectExplorer.ConnectSftpCommand}" ToolTip.Tip="SFTP Browser">
                 <TextBlock Text="SFTP ðŸ“‚"/>
             </Button>
        </StackPanel>

        <!-- Main Status Bar -->
        <Border DockPanel.Dock="Bottom" Background="#007ACC" Height="25">
             <TextBlock Text="Ready" Foreground="White" Margin="5,0"/>
        </Border>

        <!-- Main Content Split -->
        <Grid ColumnDefinitions="300, 5, *">
             
            <!-- Project Explorer (Left) -->
            <DockPanel Grid.Column="0" Background="#252526">
                <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="5">
                    <TextBox x:Name="ProjectIdBox" Watermark="Project ID" Width="200" Margin="0,0,5,0"/>
                    <Button Command="{Binding ProjectExplorer.LoadNodesCommand}" CommandParameter="{Binding #ProjectIdBox.Text}" Content="Load"/>
                </StackPanel>
                
                <TreeView ItemsSource="{Binding ProjectExplorer.RootNodes}" SelectedItem="{Binding ProjectExplorer.SelectedNode}" Background="#252526" Foreground="White">
                    <TreeView.DataTemplates>
                        <TreeDataTemplate DataType="vm:ProjectNode" ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Icon}" Margin="0,0,5,0"/>
                                <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                            </StackPanel>
                        </TreeDataTemplate>
                        <TreeDataTemplate DataType="vm:ZoneNode" ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Icon}" Margin="0,0,5,0"/>
                                <TextBlock Text="{Binding Name}"/>
                            </StackPanel>
                        </TreeDataTemplate>
                        <DataTemplate DataType="vm:InstanceNode">
                             <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Icon}" Margin="0,0,5,0"/>
                                <TextBlock Text="{Binding Name}"/>
                                <StackPanel.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Connect via SSH" 
                                                  Command="{Binding $parent[Window].((vm:MainViewModel)DataContext).ProjectExplorer.ConnectCommand}"/>
                                        <MenuItem Header="Connect via RDP" 
                                                  Command="{Binding $parent[Window].((vm:MainViewModel)DataContext).ProjectExplorer.ConnectRdpCommand}"/>
                                        <MenuItem Header="Browse Files (SFTP)" 
                                                  Command="{Binding $parent[Window].((vm:MainViewModel)DataContext).ProjectExplorer.ConnectSftpCommand}"/>
                                    </ContextMenu>
                                </StackPanel.ContextMenu>
                            </StackPanel>
                        </DataTemplate>
                    </TreeView.DataTemplates>
                </TreeView>
            </DockPanel>
            
            <!-- Splitter -->
            <GridSplitter Grid.Column="1" Background="#333333" ResizeDirection="Columns"/>

            <!-- Active Sessions (Right) -->
            <Border Grid.Column="2" Background="#1E1E1E">
                <TabControl ItemsSource="{Binding Connections}" SelectedItem="{Binding SelectedConnection}">
                    <TabControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ’»" Margin="0,0,5,0" IsVisible="{Binding $parent[TabItem].Content, Converter={x:Static ObjectConverters.IsNull}}"/> 
                                <TextBlock Text="{Binding Title}"/>
                            </StackPanel>
                        </DataTemplate>
                    </TabControl.ItemTemplate>
                </TabControl>
            </Border>
        </Grid>
    </DockPanel>
</Window>
